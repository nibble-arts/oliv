<?PHP
//
// OLIV
//
// This file is part of the OLIV Content Management System.
//
// Copyright(c) 2012 Thomas H Winkler
// thomas.winkler@iggmp.net
//
// This file may be licensed under the terms of of the
// GNU General Public License Version 3 (the ``GPL'').
//
// Software distributed under the License is distributed
// on an ``AS IS'' basis, WITHOUT WARRANTY OF ANY KIND, either
// express or implied. See the GPL for the specific language
// governing rights and limitations.
//
// You should have received a copy of the GPL along with this
// program. If not, go to http://www.gnu.org/licenses/gpl.html
// or write to the Free Software Foundation, Inc.,
// 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
//

//------------------------------------------------------------------------------
// Link/site route system
//
// Version 0.1
//------------------------------------------------------------------------------

if (!system::OLIVCORE()) die ("route.php - OLIVCore not present");


$_PAGES = array();



//TODO
// insert: also use normal links

class OLIVRoute
{

  public function __construct()
  {
    $this->scan(status::lang());
    $this->route();
  }


//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ROUTER

// get link id from language coded /module/value
  private function route()
  {
		$tempArray = $this->parseUrl(status::url()); // extract values from url

		status::set('url',$tempArray['url']);
 		status::append('val',$tempArray['val']); // add values to val-parameter


// routable url found
    if (status::url())
    {
      if ($newVal = OLIVRoute::getUrl(status::url()))
			{
        status::set('url',$newVal);
			}
      else
      {
        OLIVError::fire ("route.php::route - rescan route information");
      }
    }
// no site defined -> call OLIV_INDEX
    else
    {
      status::set('url',system::OLIV_INDEX_PAGE());
    }
		status::set('OLIV_PAGE',system::OLIV_SITE_NAME() . " " . $this->translatePageName(status::lang(),status::url()));
  }


//------------------------------------------------------------------------------
// decode friendly url
// $url ... friendly string (index.php/part1/part2...)
// $names ... optional array of names for associative array
//						if count($urlArray) > count($names), the rest is returned in the last parameter of names 
	public static function decode($url,$names = array())
	{
		if ($url)
		{
			$urlArray = explode("/",cut_slash($url));

			// return assoziative array if names defined
			if (is_array($names))
			{
				$x = 0;
				$retArray = array();
				$length = count($urlArray);

				while ($x	< $length)
				{
					if (isset($names[$x]))
					{
						$rest = implode("/",$urlArray);
						$value = array_shift($urlArray);
						$retArray[$names[$x]] = $value; // insert url part
					}
					else
					{
						if ($x)
							$retArray[$names[$x-1]] = $rest; // insert rest of url
						break;
					}
					$x++;
				}
				return($retArray);
			}
			else
				return($urlArray);
		}
	}


//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// GENERATOR
//


//------------------------------------------------------------------------------
// create intern link
// options array contains url information and href options
// array(array(mod,urletc.),array(id,title,etc.))
  static public function link($text,$options = array())
  {
    $url = "";
    $val = "";
    $param = "";
    $class = "";
    $lang = "";
    $linkParamString = "";


// link parameters
		foreach ($options['link'] as $key => $entry)
		{
// filter url and var parameters
			switch ($key)
			{
				case 'url':
					if ($url = strtolower($entry));
					else
						return ($text);

					break;

				case 'lang':
					$lang = $entry;
					break;
					
				case 'val':
					$val = $entry;
					break;

				default:
					$linkParamString .= "$key='$entry' ";
					break;
			}
		}


// get common parameters
    if (isset($options['param'])) $param = $options['param'];
    if (isset($options['class'])) $class = $options['class'];

    if (!$lang) $lang = status::lang(); // if no language use current


//------------------------------------------------------------------------------
// create extern link
		if (link_is_extern($url))
			$path = $url;


//------------------------------------------------------------------------------
// create intern link
		else
		{
		  $path = OLIVRoute::makeUrl($lang,$url) . "/";
		  if ($val) $path .= $val . "/";
		}


// insert clipboard
		if ($clipBoard = OLIVClipboard::_())
			$clipBoard = "?clipboard=$clipBoard ";


// create parameter string
    $param = OLIVRoute::makeParam($param);


// insert class
    if ($class) $class = "class='{$class}'";

// return href string
    return ("<a $class href='{$path}{$clipBoard}' $linkParamString $param>$text</a>");
  }


//------------------------------------------------------------------------------
// get page title
	static public function translateTitle($url)
	{
		global $_PAGES;

		if (array_key_exists($url,$_PAGES)) // url defined
			echoall($_PAGES[$url]->define->title);
				return (OLIVText::xml($_PAGES[$url]->define->title));
	}
	

//------------------------------------------------------------------------------
//TODO make url basis for intern, extern, form, e.i.
// create form url
  static public function url($text,$options="")
  {
    $url = "";
    $val = "";
    $lang = "";

    if (array_key_exists('url',$options)) $url = strtolower($options['url']);
    if (array_key_exists('val',$options)) $val = $options['val'];
    if (array_key_exists('lang',$options)) $lang = $options['lang']; // get link language

    if (!$lang) $lang = status::lang(); // if no language use current
    
    $path = OLIVRoute::makeUrl($lang,$url) . "/";
    if ($val) $path .= $val . "/";

    // return url string
    return ($path);
  }



//------------------------------------------------------------------------------
// return parameter string for link
  static public function makeUrl($lang,$url)
  {
		if ($url)
		{
		  $routeArray = array(system::OLIV_PROTOCOL() . system::OLIV_HOST() . system::OLIV_BASE() . system::OLIV_SCRIPT_NAME());

		  if ($lang) array_push($routeArray,$lang);
		  else
		    $lang = status::lang();

// use friendly name for url
		  $val = OLIVRoute::translateFriendlyName($lang,$url);

		  
		  if ($url[strtolower($val)]) array_push($routeArray,$val);
		  return (implode("/",$routeArray));
		}
  }


//------------------------------------------------------------------------------
// return parameter string for link
  static private function makeParam($param)
  {
    $paramArray = array();

    if (is_array($param))
    {
      foreach ($param as $key => $value)
      {
        if ($key == "title") // use multilingual expression for title
          $value = OLIVText::_($value);

        array_push($paramArray,"$key='$value'");
      }
    }
    return (implode(" ",$paramArray));
  }
  

//------------------------------------------------------------------------------
// translate url to lang pageName
  static public function translatePageName($lang,$url)
  {
    global $_PAGES;

// return translated page
		if (array_key_exists($url,$_PAGES))
			return OLIVText::xml($_PAGES[$url]->define->name);

		else
// return untranslated
			return $url;
  }


//------------------------------------------------------------------------------
// translate url to lang pageName
  static public function translateFriendlyName($lang,$url)
  {
    global $_PAGES;

		if (array_key_exists($url,$_PAGES))
			return (OLIVText::xml($_PAGES[$url]->define->friendly_name,$lang));
		else
// return untranslated
			return $url;
  }


//------------------------------------------------------------------------------
// translate pageName to url id
  static public function getUrl($name)
  {
    global $_PAGES;
    $id = "";

/*    foreach($_PAGES as $entry)
    {
			$xml = $entry['text']->FRIENDLY_NAME;


// look for all translations
			if ($entry['text']->FRIENDLY_NAME->xpath("text[.='" . $name . "']"))
			{
// set pagename to name defined by status::lang
				if ($langName = $entry['text']->FRIENDLY_NAME->xpath("text[@lang='" . status::lang() . "']"))
				{
					status::set('url',(string)$langName[0]);
				}

//echoall((string)$entry['define']->attributes()->id);				
// return page id
				return ((string)$entry['text']->ID->text);
			}
    }*/
  }


//------------------------------------------------------------------------------
//TODO
// parse url for subpages
// extract and returns parameters for modules
//
// get information from content.xml for this purpose
  static public function parseUrl($url)
  {
    $retArray = array();
    $paramArray = array();
    $tempArray = array();
    

		$urlArray = explode("/",cut_slash($url));

    // search for url matches
    foreach($urlArray as $entry)
    {
      array_push($tempArray,$entry);
      $urlString = implode(".",$tempArray);

      if (!OLIVRoute::getUrl($urlString))
        array_push($paramArray,$entry); // insert parameter part
      else
        array_push($retArray,$entry); // insert url part
    }

    return (array("url" => implode("/",$retArray),"val" => implode("/",$paramArray))); // return parameters
  }



//------------------------------------------------------------------------------
// return array of pages
	public static function getPages()
	{
		global $_PAGES;
		$retArray = array();


		foreach ($_PAGES as $key => $value)
		{
			$retArray[$key] = $value['text'];
		}
		return($retArray);
	}


//------------------------------------------------------------------------------
// get list of existing pages
  public function scan($lang)
  {
		global $_PAGES;


    $path = system::OLIV_PAGE_PATH();
    if ($pageDir = sessionopendir ($path))
    {
      while ($file = readdir($pageDir))
      {
        if (sessionis_dir($path . $file) and $file != "." and $file != "..")
        {
          // get page definition.xml
          if (sessionfile_exists($path . $file . "/$file.xml"))
          {
            $xml = sessionxml_load_file($path . $file . "/$file.xml");

            $_PAGES[$file] = $xml;
          }
        }
      }
      closedir ($pageDir);
    }
    else
      OLIVError::fire("page::scan - directory $path not found");

//    echoall($_PAGES);
  }
}



//------------------------------------------------------------------------------
// removes slash from start and end of string
function cut_slash($url)
{
  if (substr($url,0,1) == "/") $url = substr($url,1);
  if (strlen($url) > 0)
    if ($url[strlen($url)-1] == "/")
      $url = substr($url,0,strlen($url)-1);

  return ($url);
}


//------------------------------------------------------------------------------
// check if link is extern with http / https protocoll or mailto
function link_is_extern($url)
{
	if (substr($url,0,5) == "http:" or
		substr($url,0,6) == "https:" or
		substr($url,0,11) == "javascript:" or
		substr($url,0,7) == "mailto:"
	)
		return (TRUE);
}
?>
